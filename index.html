<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>
      The Screen Orientation API
    </title>
    <script src='https://www.w3.org/Tools/respec/respec-w3c-common' class=
    'remove'></script>
    <script class='remove'>
    // (this is to make tidy happy)
    var respecConfig = {
      specStatus: "ED",
      shortName: "screen-orientation",
      previousPublishDate: "2015-04-28",
      previousMaturity: "WD",
      editors: [
        {
          name: "Mounir Lamouri",
          company: "Google Inc.",
          w3cid: 45389,
        },
        {
          name: "Marcos Cáceres",
          company: "Mozilla",
          w3cid: 39125,
        },
      ],
      testSuiteURI:
        "https://w3c-test.org/screen-orientation/",
      github: "https://github.com/w3c/screen-orientation",
      wg: "Web Platform Working Group",
      wgURI: "https://www.w3.org/WebPlatform/WG/",
      wgPatentURI: "https://www.w3.org/2004/01/pp-impl/83482/status",
      caniuse: "screen-orientation",
    };
    </script>
    <style>
    table {
    table-layout: fixed;
    width: 100%;
    border-collapse: collapse;
    border: 2px solid;
    margin:20px;
    }

    th {
      width: 20%;
      border: 2px solid;
    }

    td {
      border: 1px solid;
    }

    th, td {
      padding: 10px;
    }
    </style>
  </head>
  <body>
    <section id='abstract'>
      <p>
        The <cite>Screen Orientation API</cite> provides the ability to read
        the screen orientation type and angle, to be informed when the screen
        orientation changes, and to lock the screen to a specific orientation.
      </p>
    </section>
    <section id='sotd'>
      <p>
        This document is a work in progress.
      </p>
    </section>
    <section data-dfn-for='Screen'>
      <h2>
        Extensions to the <a>Screen</a> interface
      </h2>
      <p>
        The <a data-cite="CSSOM-View">CSSOM View Module</a> specification
        defines the <code><dfn data-cite=
        "CSSOM-View#screen">Screen</dfn></code> interface, which this
        specification extends:
      </p>
      <pre class='idl'>
          partial interface Screen {
            [SameObject] readonly attribute ScreenOrientation orientation;
          };
        </pre>
      <section>
        <h2>
          <dfn>orientation</dfn> attribute
        </h2>
        <p>
          The <a data-link-for="Screen">orientation</a> attribute is an
          instance of <a>ScreenOrientation</a>.
        </p>
      </section>
    </section>
    <section data-dfn-for='ScreenOrientation' data-link-for=
    'ScreenOrientation'>
      <h2>
        <dfn>ScreenOrientation</dfn> interface
      </h2>
      <pre class='idl'>
          [Exposed=Window]
          interface ScreenOrientation : EventTarget {
            Promise&lt;void&gt; lock(OrientationLockType orientation);
            void unlock();
            readonly attribute OrientationType type;
            readonly attribute unsigned short angle;
            attribute EventHandler onchange;
          };
        </pre>
      <section>
        <h2>
          <dfn>lock()</dfn> method
        </h2>
        <p>
          When the <a>lock()</a> method is invoked, the <a>user agent</a> MUST
          run the <a>apply an orientation lock</a> steps to the <a>responsible
          document</a> using <var>orientation</var>.
        </p>
      </section>
      <section>
        <h2>
          <dfn>unlock()</dfn> method
        </h2>
        <p>
          When the <a>unlock()</a> method is invoked, the <a>user agent</a>
          MUST run the steps to <a>lock the orientation</a> of the
          <a>responsible document</a> to the <a>responsible document</a>'s
          <a>default orientation</a>.
        </p>
        <p class='note'>
          <a>unlock()</a> does not return a promise because it is equivalent to
          locking to the <a>default orientation</a> which might or might not be
          known by the <a>user agent</a>. Hence, the <a>user agent</a> can not
          predict what the new orientation is going to be and even if it is
          going to change at all.
        </p>
      </section>
      <section>
        <h2>
          <dfn>type</dfn> attribute
        </h2>
        <p>
          When getting the <a>type</a> attribute, the <a>user agent</a> MUST
          return the <a>responsible document</a>'s <a>current orientation
          type</a>.
        </p>
      </section>
      <section>
        <h2>
          <dfn>angle</dfn> attribute
        </h2>
        <p>
          When getting the <a>angle</a> attribute, the <a>user agent</a> MUST
          return the <a>responsible document</a>'s <a>current orientation
          angle</a>.
        </p>
        <div class='note'>
          <p>
            <a>angle</a> indicates how far the user has turned the device
            counterclockwise from the natural orientation. When the device is
            rotated 90° counterclockwise, the screen compensates by rotating
            90° clockwise, so <a>angle</a> returns <code>90</code>.
          </p>
          <p>
            If the device is rotated 90° clockwise from its natural
            orientation, the screen compensates by rotating 90°
            counterclockwise, so <a>angle</a> returns <code>270</code>.
          </p>
          <p>
            The value returned by this property is always in the range 0-359.
            It never returns negative values.
          </p>
        </div>
      </section>
      <section>
        <h2>
          <dfn>onchange</dfn> attribute
        </h2>
      </section>
      <p>
        The <a>onchange</a> attribute is an <a>event handler</a> whose
        corresponding <a>event handler event type</a> is <code>"change"</code>.
      </p>
    </section>
    <section>
      <h2>
        <dfn>OrientationType</dfn> enum
      </h2>
      <pre class='idl'>
          enum OrientationType {
            "portrait-primary",
            "portrait-secondary",
            "landscape-primary",
            "landscape-secondary"
          };
        </pre>
    </section>
    <section data-link-for="OrientationLockType" data-dfn-for=
    "OrientationLockType">
      <h2>
        <dfn>OrientationLockType</dfn> enum
      </h2>
      <pre class='idl'>
          enum OrientationLockType {
            "any",
            "natural",
            "landscape",
            "portrait",
            "portrait-primary",
            "portrait-secondary",
            "landscape-primary",
            "landscape-secondary"
          };
        </pre>
    </section>
    <section>
      <h2>
        Concepts
      </h2>
      <p>
        The term <dfn data-lt="screen concept" data-lt-nodefault=
        "">screen</dfn> is equivalent to the screen of the output device
        associated to the <a>Window</a>, as per [[CSSOM-VIEW]].
      </p>
      <p>
        Algorithms defined in this specification assume that for each
        <a>document</a> there is a <dfn>pending promise</dfn>, which is
        initially set to <code>null</code>, which is a promise whose associated
        operation is to lock the screen orientation.
      </p>
      <section data-dfn-for='OrientationType' data-link-for="OrientationType">
        <h2>
          Reading the screen orientation
        </h2>
        <p>
          All <a data-lt='document'>documents</a> have a <dfn>current
          orientation type</dfn> and a <dfn>current orientation angle</dfn>.
          Both of them SHOULD be initialized when the <a>document</a> is
          created, otherwise they MUST be initialized the first time they are
          accessed and before their value is read. The <a>user agent</a> MUST
          <a>update the orientation information</a> of the <a>document</a> to
          initialize them.
        </p>
        <p>
          For a given <a>document</a>, the <a>current orientation type</a> and
          the <a>current orientation angle</a> are strongly linked in the sense
          that for any given type, there will be a specific angle associated.
        </p>
        <p>
          One primary orientation will always be determined by the natural
          orientation of the device and this will then determine the secondary
          value of its related orientation.
        </p>
        <p>
          For example a device held in its natural portrait orientation would
          have a current orientation of <a>portrait-primary</a> and its
          <a>portrait-secondary</a> orientation would be its position when
          rotated 180°.
        </p>
        <p>
          The <a>user agent</a> can associate the other <code>*-primary</code>
          and <code>*-secondary</code> values at will. For example, it can be
          based on the device preferred angles, the user's preferred
          orientations or the current orientation when the application starts.
        </p>
        <p>
          The <a>screen orientation values table</a> presents the primary and
          secondary values that are determined by the device's natural
          orientation and the possibilities available to the <a>user agent</a>
          for setting the other primary and secondary orientation values.
        </p>
        <table>
          <caption>
            The <dfn>screen orientation values table</dfn>
          </caption>
        </table>
        <table data-link-for="OrientationType">
          <thead>
            <tr>
              <th>
                Natural Orientation
              </th>
              <th>
                Primary Orientation 1
              </th>
              <th>
                Secondary Orientation 1
              </th>
              <th>
                Primary Orientation 2
              </th>
              <th>
                Secondary Orientation 2
              </th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                Portrait
              </td>
              <td>
                <a>portrait-primary</a><br>
                <a data-link-for="ScreenOrientation">Angle</a> <code>0</code>
              </td>
              <td>
                <a>portrait-secondary</a><br>
                <a data-link-for="ScreenOrientation">Angle</a> <code>180</code>
              </td>
              <td>
                <a>landscape-primary</a><br>
                <a>User agent</a> to set at either <a data-link-for=
                "ScreenOrientation">Angle</a> <code>90</code> or
                <a data-link-for="ScreenOrientation">Angle</a> <code>270</code>
              </td>
              <td>
                <a>landscape-secondary</a><br>
                Set at the angle not used for landscape-primary
              </td>
            </tr>
            <tr>
              <td>
                Landscape
              </td>
              <td>
                <a>landscape-primary</a><br>
                <a data-link-for="ScreenOrientation">Angle</a> <code>0</code>
              </td>
              <td>
                <a>landscape-secondary</a><br>
                <a data-link-for="ScreenOrientation">Angle</a> <code>180</code>
              </td>
              <td>
                <a>portrait-primary</a><br>
                <a>User agent</a> to set at either <a data-link-for=
                "ScreenOrientation">Angle</a> <code>90</code> or
                <a data-link-for="ScreenOrientation">Angle</a> <code>270</code>
              </td>
              <td>
                <a>portrait-secondary</a><br>
                Set at the angle not used for portrait-primary
              </td>
            </tr>
          </tbody>
        </table>
        <p>
          Once the <a>user agent</a> has set the primary and secondary values
          from the options in the <a>screen orientation values table</a>, the
          <a>current orientation type</a> and the <a>current orientation
          angle</a> relation MUST be kept consistent for any given
          <a>document</a>.
        </p>
        <div class='practice'>
          <span class='practicelab'>orientation.angle and orientation.type
          relationship</span>
          <p class='practicedesc'>
            Never assume any cross-devices relationship between the screen
            orientation type and the screen orientation angle. Any assumption
            would be wrong given that a device might have <code>90</code> and
            <code>270</code> as the angles for <code>landscape</code> types but
            another device will have <code>0</code> and <code>180</code>,
            depending on its natural orientation. Instead, it is recommended to
            check during runtime the relationship between angle and type.
          </p>
        </div>
      </section>
      <section data-dfn-for='OrientationLockType'>
        <h2>
          Locking the screen orientation
        </h2>
        <p>
          The <a>user agent</a> MAY require a <a>document</a> and its
          associated <a>browsing context</a> to meet one or more <dfn>security
          conditions</dfn> in order to be able to lock the screen orientation.
          For example, a <a>user agent</a> might require a <a>document</a>'s
          <a>top-level browsing context</a> to be fullscreen (see <a href=
          '#interaction-with-fullscreen-api'>Interaction with Fullscreen
          API</a>) in order to allow an orientation lock.
        </p>
        <p>
          The <a>user agent</a> MAY reject all attempts to lock the screen
          orientation if the platform conventions do not expect applications to
          be able to change the screen orientation. For example, on most
          desktop platforms, applications can not change the screen
          orientation.
        </p>
        <p>
          If the <a>user agent</a> supports locking the screen orientation, it
          MUST allow the screen to be locked to all of the states of the
          <a><code>OrientationLockType</code></a> enum.
        </p>
        <p>
          A <a>document</a>'s <dfn>orientation lock</dfn> is the orientation
          lock that applies on its <a>top-level browsing context</a>. An
          orientation lock is an unordered set of <a>OrientationType</a>.
        </p>
      </section>
      <section>
        <h2>
          Default orientation
        </h2>
        <p>
          A <a>document</a>'s <dfn>default orientation</dfn> is the set of
          orientations to which the screen orientation is locked when it is not
          explicitly locked by this API or any other means.
        </p>
        <p data-link-for="OrientationLockType">
          For the perspective of a <a>document</a>, locking to the <a>default
          orientation</a> is equivalent to unlocking because it means that it
          no longer has a lock applied. However, it does not mean that the
          <a>default orientation</a> has to be <a>any</a>.
        </p>
      </section>
    </section>
    <section>
      <h2>
        Interactions with other specifications
      </h2>
      <p>
        This section explains how this specification interacts with other
        related specifications of the platform.
      </p>
      <section>
        <h2>
          Interaction with Fullscreen API
        </h2>
        <p>
          As a <a>security condition</a>, a user agent MAY restrict locking the
          screen orientation exclusively to when the <a>top-level browsing
          context</a>'s <a>document</a>'s <a>fullscreen element</a> is not
          null. When that <a>security condition</a> applies, whenever the
          <a>document</a>'s <a>fullscreen element</a> is empty and a screen
          orientation lock is applied, the <a>user agent</a> MUST <a>lock the
          orientation</a> of the <a>document</a> to the <a>document</a>'s
          <a>default orientation</a>.
        </p>
        <div class='issue'>
          This section could be improved if the [[FULLSCREEN]] specification
          had a hook for when the document is no longer fullscreen. See
          <a href='https://github.com/w3c/screen-orientation/issues/62'>issue
          62</a> .
        </div>
      </section>
      <section class='informative'>
        <h2>
          Interaction with DeviceOrientation
        </h2>
        <p>
          The DeviceOrientation specification [[DEVICE-ORIENTATION]] defines a
          <code>deviceorientation</code> event that can be used to discover the
          physical orientation of the device. Such event can be used to draw
          things on the screen that could point to a specific direction. A
          basic example being a compass application. Another example would be
          an application giving direction to the user or an augmented reality
          game pointing to an objective.
        </p>
        <p>
          Drawing on the screen in order to point to a physical location
          requires to know the device orientation and the orientation of the
          screen in the device coordinates. Without the APIs defined in this
          specification, a developer has to assume that the <a>document</a>'s
          <a>current orientation angle</a> is <code>0</code>. With the help of
          the APIs described in this specification, the developer can <a>apply
          an orientation lock</a> to a <a>document</a> using
          <code>natural</code> to make that assumption a certitude. Otherwise,
          reading the <a>document</a>'s <a>current orientation angle</a> via
          <code>screen.orientation.angle</code> and listening to the
          <code>"change"</code> event can help the developer to compensate the
          screen orientation angle.
        </p>
      </section>
      <section class='informative'>
        <h2>
          Interaction with Web Application Manifest
        </h2>
        <p>
          The <a data-cite="appmanifest"></a>Web Application Manifest
          specification allows web applications to set the <a>document</a>'s
          <a>default orientation</a>.
        </p>
      </section>
      <section class='informative'>
        <h2>
          Interaction with CSS Device Adaptation
        </h2>
        <p>
          The <a data-cite="CSS-ADAPTATION">Device Adaptation</a> specification
          defines, independently of this document, a way to lock the screen
          orientation for a web page using CSS.
        </p>
      </section>
      <section class='informative'>
        <h2>
          Interaction with Web Content Accessibility Guidelines
        </h2>
        <p>
          The <a data-cite="WCAG21">Web Content Accessibility Guidelines</a>
          includes a Success Criterion (<a data-cite=
          "WCAG21#orientation">Success Criterion Orientation</a>) related to
          screen orientation.
        </p>
        <p>
          ​The intent of this Success Criterion is to ensure that all
          <a data-cite="WCAG21#dfn-essential">essential</a> content and
          functionality is available regardless of the display orientation
          (portrait or landscape). Some websites and applications automatically
          set the screen to a particular display orientation and expect that
          users will respond by rotating their device to match.
        </p>
        <p>
          However, some users may have their devices mounted in a fixed
          orientation (e.g. on the arm of a power wheelchair). Therefore,
          websites and applications need to support both orientations by making
          sure <a data-cite="WCAG21#dfn-essential">essential</a> content and
          functionality is available in each orientation. While the order of
          content and method of functionality may have differences the content
          and functionality must always be available. When a particular
          orientation is <a data-cite="WCAG21#dfn-essential">essential</a>, the
          user needs to be advised of the orientation requirements.​
        </p>
      </section>
    </section>
    <section class='informative'>
      <h2>
        Examples
      </h2>
      <p>
        In this example for a mobile device, clicking the Rotate button makes a
        request to go fullscreen and then lock to the opposite orientation. If
        the device is not in it's default orientation, pressing the unlock
        button reverts the screen orientation back to default.
      </p>
      <p>
        The log shows the change in orientation type and angle.
      </p>
      <pre class='example html'>
&lt;script&gt;
async function fullScreenCheck() {
  if (document.fullscreenElement === null) {
    await document.body.requestFullscreen();
  }
}

async function unlock() {
  await fullScreenCheck();
  await screen.orientation.unlock();
}

async function rotate() {
  const rotateBtn = document.getElementById("rotateBtn");
  await fullScreenCheck();
  const newOrientation = screen.orientation.type.startsWith("portrait")
    ? "landscape"
    : "portrait";
  await screen.orientation.lock(newOrientation);
  rotateBtn.textContent = `Rotate to ${newOrientation}`;
}

function show() {
  const { type, angle } = screen.orientation;
  console.log(`Orientation type is ${type} & angle is ${angle}`);
}

screen.orientation.addEventListener("change", show);
window.addEventListener("load", show);
&lt;/script&gt;

&lt;button onclick="rotate() id="rotateBtn"&gt;
  Rotate
&lt;/button&gt;
&lt;button onclick='unlock()'&gt;
  Unlock
&lt;/button&gt;
</pre>
      <p>
        This example waits to be fullscreen before locking the screen
        orientation and starting.
      </p>
      <pre class='example html'>
&lt;script&gt;
  var start = function() {
    document.onfullscreenchange = function() {
      screen.orientation.lock('natural').then(startInternal);
    }
    document.documentElement.requestFullscreen();
  }
&lt;/script&gt;
&lt;button onclick='start();'&gt;
  Start
&lt;/button&gt;

</pre>
      <p>
        This example asks the user to manually rotate the device if the Screen
        Orientation API is not available.
      </p>
      <pre class='example js'>
&lt;script&gt;
  var start = function() {
    screen.orientation.lock('landscape-primary').then(
      startInternal,
      function() {
        alert('To start, rotate your screen to landscape.');

        var orientationChangeHandler = function() {
          if (!screen.orientation.type.startsWith('landscape')) {
            return;
          }
          screen.orientation.removeEventListener('change', orientationChangeHandler);
          startInternal();
        }

        screen.orientation.addEventListener('change', orientationChangeHandler);
      });
  }
  window.onload = start;
&lt;/script&gt;

</pre>
    </section>
    <section>
      <h2>
        Algorithms
      </h2>
      <section data-dfn-for="OrientationType">
        <h2>
          Updating orientation algorithm
        </h2>
        <p>
          The steps to <dfn>update the orientation information</dfn> of a
          <a>document</a> are as follows:
        </p>
        <ol>
          <li>If the screen width is greater than the screen height, set the
          <a>document</a>'s <a>current orientation type</a> to
          <dfn>landscape-primary</dfn> or <dfn>landscape-secondary</dfn>.
          </li>
          <li>Otherwise, if the screen width is less than or equal to the
          screen height, set the <a>document</a>'s <a>current orientation
          type</a> to <dfn>portrait-primary</dfn> or
          <dfn>portrait-secondary</dfn>.
          </li>
          <li>Set the <a>document</a>'s <a>current orientation angle</a> to the
          clockwise angle in degrees between the orientation of the viewport as
          it is drawn and the natural orientation of the device (i.e., the top
          of the physical screen). This is the opposite of the physical
          rotation. In other words, if a device is turned 90 degrees on the
          right, the <a>current orientation angle</a> would be 270 degrees.
          </li>
        </ol>
      </section>
      <section data-dfn-for="OrientationLockType">
        <h2>
          Locking orientation algorithm
        </h2>
        <p>
          The steps to <dfn>apply an orientation lock</dfn> to a
          <a>document</a> using <var>orientation</var> are as follows:
        </p>
        <ol>
          <li>If the <a>user agent</a> does not support locking the screen
          orientation, return a promise rejected with a
          <code>DOMException</code> whose name is
          <code>NotSupportedError</code> and abort these steps.
          </li>
          <li>The following sub-steps MAY be run asynchronously for performance
          reasons, for example, if the <a>user agent</a> has <a data-lt=
          'browsing context'>browsing contexts</a> living in different
          processes:
            <ol>
              <li>Let <var>browsing contexts</var> be the <a>list of the
              descendant browsing contexts</a> of the <a>top-level browsing
              context</a>'s <a>document</a>.
              </li>
              <li>If one of the <var>browsing contexts</var>'s
              <a>document</a>'s <a>pending promise</a> is not
              <code>null</code>:
                <ol>
                  <li>Let <var>doc</var> be the <a>document</a> which has a not
                  <code>null</code> <a>pending promise</a>.
                  </li>
                  <li>Reject <var>doc</var>'s <a>pending promise</a> with
                  <code>DOMException</code> whose name is
                  <code>AbortError</code>.
                  </li>
                  <li>Set <var>doc</var>'s <a>pending promise</a> to
                  <code>null</code> .
                  </li>
                </ol>
              </li>
            </ol>
          </li>
          <li>If the <a>document</a>'s <a>active sandboxing flag set</a> has
          the <a>sandboxed orientation lock browsing context flag</a> set, or
          <a>user agent</a> doesn't meet the <a>security conditions</a> to
          perform an orientation change, return a promise rejected with a
          <code>DOMException</code> whose name is <code>SecurityError</code>
          and abort these steps.
          </li>
          <li>Let <var>orientations</var> be an empty list.
          </li>
          <li>Depending on <var>orientation</var> value, do the following:
            <dl>
              <dt>
                <dfn>portrait-primary</dfn> or <dfn>portrait-secondary</dfn> or
                <dfn>landscape-primary</dfn> or <dfn>landscape-secondary</dfn>
              </dt>
              <dd>
                Append <var>orientation</var> to <var>orientations</var>.
              </dd>
              <dt>
                <dfn data-dfn-for='OrientationLockType'>landscape</dfn>
              </dt>
              <dd>
                Depending on platform convention, append
                <code>landscape-primary</code>, or
                <code>landscape-secondary</code>, or both to
                <var>orientations</var>.
              </dd>
              <dt>
                <dfn data-dfn-for='OrientationLockType'>portrait</dfn>
              </dt>
              <dd>
                Depending on platform convention, append
                <code>portrait-primary</code>, or
                <code>portrait-secondary</code>, or both to
                <var>orientations</var>.
              </dd>
              <dt>
                <dfn data-dfn-for='OrientationLockType'>natural</dfn>
              </dt>
              <dd>
                Append <code>portrait-primary</code> or
                <code>landscape-primary</code> to <var>orientations</var> such
                as the associated <a>current orientation angle</a> is 0.
              </dd>
              <dt>
                <dfn data-dfn-for='OrientationLockType'>any</dfn>
              </dt>
              <dd>
                Append <code>portrait-primary</code>,
                <code>portrait-secondary</code>, <code>landscape-primary</code>
                and <code>landscape-secondary</code> to
                <var>orientations</var>.
              </dd>
            </dl>
          </li>
          <li>Set <var>doc</var>'s <a>pending promise</a> to a newly-created
          promise.
          </li>
          <li>Return <var>doc</var>'s <a>pending promise</a> and continue
          asynchronously.
          </li>
          <li>
            <a>Lock the orientation</a> of the <a>document</a> to
            <var>orientations</var>.
          </li>
          <li>If locking the orientation did not result in a change of
          orientation, as part of the next <a>animation frame task</a>, resolve
          <var>pending-promise</var> with <code>undefined</code> and set <var>
            pending-promise</var> to <code>null</code>.
          </li>
        </ol>
        <div class='note'>
          If locking the orientation results in an orientation change, the
          promise will be resolved when the orientation will change as
          described in the <a>Screen orientation change algorithm</a>.
        </div>
        <p>
          When the <a>user agent</a> has to <dfn>lock the orientation</dfn> of
          a <a>document</a> to <var>orientations</var>, it MUST run the
          following steps:
        </p>
        <ol>
          <li>Set the <a>document</a>'s <a>orientation lock</a> to
          <var>orientations</var>.
          </li>
          <li>If the <a>active orientation lock</a> is not the
          <a>document</a>'s <a>orientation lock</a>, abort these steps.
          </li>
          <li>If the <a>active orientation lock</a> value is equal to
          <var>orientations</var> value, abort these steps.
          </li>
          <li>If <var>orientations</var> contains only one value, run the
          following sub-steps:
            <ol>
              <li>Let <var>orientation</var> be the value contained in
              <var>orientations</var>.
              </li>
              <li>Change how the viewport is drawn so that the
              <a>document</a>'s <a>current orientation type</a> will be equal
              to <var>orientation</var>.
              </li>
              <li>After the change has happened, prevent the <a>document</a>'s
              <a>top-level browsing context</a>'s screen orientation from
              changing until those steps are run again.
              </li>
              <li>Abort these steps.
              </li>
            </ol>
          </li>
          <li>If the <a>document</a>'s <a>current orientation type</a> is not
          part of <var>orientations</var>, change how the viewport is drawn
          such as the <a>document</a>'s <a>current orientation type</a> will be
          equal to one of <var>orientations</var>' values.
          </li>
          <li>Otherwise, depending on platform conventions, change how the
          viewport is drawn in order to make it match another screen
          orientation type. However, it has to be part of
          <var>orientations</var>.
          </li>
          <li>Allow the user to change the screen orientation to any value part
          of <var>orientations</var> and only those values until those steps
          are run again. The method to define the current screen orientation
          has to match the platform conventions.
          </li>
        </ol>
      </section>
      <section>
        <h2>
          Active orientation lock algorithm
        </h2>
        <p>
          To determine the <dfn>active orientation lock</dfn>, the <a>user
          agent</a> MUST run the following steps:
        </p>
        <ol>
          <li>If there is only one <a>top-level browsing context</a> with a <a>
            document</a> that is visible per [[!PAGE-VISIBILITY]], the
            <a>active orientation lock</a> is the <a>document</a>'s
            <a>orientation lock</a>.
          </li>
          <li>Otherwise, if there are more than one <a>top-level browsing
          context</a> with a <a>document</a> that is visible per
          [[!PAGE-VISIBILITY]] but only one of those <a>document</a>s is
          focused, the <a>active orientation lock</a> is the focused
          <a>document</a>'s <a>orientation lock</a>.
          </li>
          <li>Otherwise, the <a>active orientation lock</a> SHOULD be the
          latest focused <a>document</a>'s <a>orientation lock</a>, unless
          stated otherwise by the platform conventions.
          </li>
        </ol>
        <p>
          Whenever the <a>active orientation lock</a> changes, the <a>user
          agent</a> MUST run the steps to <a>lock the orientation</a> of the
          <a>document</a> to the <a>document</a>'s <a>orientation lock</a>.
        </p>
        <p>
          Whenever a <a>top-level browsing context</a> is <a>navigated</a>, the
          <a>user agent</a> MUST <a>lock the orientation</a> of the
          <a>document</a> to the <a>document</a>'s <a>default orientation</a>.
        </p>
      </section>
      <section data-link-for='ScreenOrientation'>
        <h2>
          <dfn>Screen orientation change algorithm</dfn>
        </h2>
        <p>
          Whenever the viewport's angle changes, the <a>user agent</a> MUST run
          the following steps as part of the next <a>animation frame task</a>:
        </p>
        <ol>
          <li>Let <var>browsing contexts</var> be the <a>list of the descendant
          browsing contexts</a> of the <a>top-level browsing context</a>'s <a>
            document</a>.
          </li>
          <li>For each <a>browsing context</a> in <var>browsing contexts</var>,
          run the following sub-steps:
            <ol>
              <li>Let <var>doc</var> be the <a>browsing context</a>'s <a>active
              document</a>.
              </li>
              <li>If <var>doc</var> is not visible per [[!PAGE-VISIBILITY]],
              abort these steps.
              </li>
              <li>
                <a>Update the orientation information</a> of <var>doc</var>.
              </li>
              <li>If <var>doc</var>'s <a>pending promise</a> is not
              <code>null</code>:
                <ol>
                  <li>Resolve <var>doc</var>'s <a>pending promise</a> with
                  <code>undefined</code>.
                  </li>
                  <li>Set <var>doc</var>'s <a>pending promise</a> to
                  <code>null</code> .
                  </li>
                </ol>
              </li>
              <li>If the orientation change was triggered by a user gesture
              such as the user turning the device, as opposed to a call to <a>
                lock</a>, the <a>task</a> MUST be annotated with <code>process
                user orientation change</code> when running the next step.
              </li>
              <li>
                <a>Fire an event</a> named <code>change</code> at
                <var>doc</var>'s <a>screen.orientation</a> object.
              </li>
            </ol>
          </li>
        </ol>
        <p>
          Whenever a <a>document</a> becomes visible per [[!PAGE-VISIBILITY]],
          in other words after the <a>now visible algorithm</a> is run, the
          <a>user agent</a> MUST run the following substeps as part of the next
          <a>animation frame task</a>:
        </p>
        <ol>
          <li>Let <var>type</var> and <var>angle</var> be respectively the <a>
            document</a>'s <a>current orientation type</a> and <a>current
            orientation angle</a>.
          </li>
          <li>
            <a>Update the orientation information</a> of the <a>document</a>.
          </li>
          <li>If <var>type</var> is different from the <a>document</a>'s
          <a>current orientation type</a> or <var>angle</var> from the
          <a>document</a>'s <a>current orientation angle</a>, run the following
          sub-steps:
            <ol>
              <li>If the <a>document</a>'s <a>pending promise</a> is not <code>
                null</code>:
                <ol>
                  <li>Resolve the <a>document</a>'s <a>pending promise</a> with
                  <code>undefined</code>.
                  </li>
                  <li>Set the <a>document</a>'s <a>pending promise</a> to
                  <code>null</code>.
                  </li>
                </ol>
              </li>
              <li>If the orientation change was triggered by a user gesture
              such as the user turning the device, as opposed to a call to <a>
                lock</a>, the <a>task</a> MUST be annotated with <code>process
                user orientation change</code> when running the next step.
              </li>
              <li>
                <a>Fire an event</a> named <code>change</code> at the
                <a>document</a>'s <a>screen.orientation</a> object.
              </li>
            </ol>
          </li>
        </ol>
        <p>
          An algorithm is <dfn>triggered by a user generated orientation
          change</dfn> if the <a>task</a> in which the algorithm is running is
          annotated with <code>process user orientation change</code>.
        </p>
        <div class="note">
          <p>
            Developers need to be aware that a <a>screen.orientation</a> object
            from a <a>document</a> that is not visible, as per
            [[PAGE-VISIBILITY]], will not receive an orientation change event.
            This is to prevent unnecessary changes to layout, etc. in the
            non-visible web application.
          </p>
        </div>
        <div class='issue'>
          This section could be improved if the [[PAGE-VISIBILITY]]
          specification had a hook for when the document becomes visible and
          hidden. <a href=
          'https://github.com/w3c/screen-orientation/issues/77'>issue 77</a>.
        </div>
      </section>
    </section>
    <section class='informative'>
      <h2>
        Privacy and Security Considerations
      </h2>
      <section>
        <h3>
          Access to aspects of a user’s local computing environment
        </h3>
        <p>
          The screen orientation type and angle of the device can be accessed
          with the API specified in this document, and can be a potential
          fingerprinting vector.
        </p>
        <p>
          The screen orientation type can already be known by using the screen
          width and height. In practice, the additional information provided
          with the API concerning the angle of the device and the primary or
          secondary screen orientation is unlikely to be used by any competent
          attack.
        </p>
      </section>
    </section>
    <section>
      <h2>
        Dependencies
      </h2>
      <p>
        The following concepts and interfaces are defined in [[HTML]]:
        <dfn data-cite="HTML/webappapis.html#event-handlers">event
        handler</dfn>, <dfn data-cite=
        "HTML/webappapis.html#event-handler-event-type">event handler event
        type</dfn>, <dfn data-cite=
        "HTML/webappapis.html#concept-task">task</dfn>, <code><dfn data-cite=
        "HTML/window-object.html#window">Window</dfn></code>,
        <code><dfn data-cite="HTML/dom.html#document">Document</dfn></code>,
        <dfn data-cite="HTML/browsers.html#browsing-context">browsing
        context</dfn>, <dfn data-cite=
        "HTML/browsers.html#top-level-browsing-context">top-level browsing
        context</dfn>, browsing context's <dfn data-cite=
        "HTML/browsers.html#active-document">active document</dfn>,
        <dfn data-cite="HTML/browsers.html#navigate">navigated</dfn> browsing
        context, <dfn data-cite=
        "HTML/browsers.html#active-sandboxing-flag-set">active sandboxing flag
        set</dfn>, <dfn data-cite=
        "HTML/browsers.html#sandboxed-orientation-lock-browsing-context-flag">sandboxed
        orientation lock browsing context flag</dfn>, <dfn data-cite=
        "HTML/webappapis.html#responsible-document">responsible document</dfn>,
        <dfn data-cite=
        "HTML/browsers.html#list-of-the-descendant-browsing-contexts">list of
        the descendant browsing contexts</dfn>.
      </p>
      <p>
        The following is defined in [[FULLSCREEN]]: <dfn data-cite=
        "FULLSCREEN#fullscreen-element">fullscreen element</dfn>.
      </p>
      <p>
        The following is defined in [[PAGE-VISIBILITY]]: <dfn data-cite=
        "PAGE-VISIBILITY#dfn-now-visible-algorithm">now visible
        algorithm</dfn>.
      </p>
      <p>
        The following is defined in [[DOM]]: <dfn data-cite=
        "DOM#concept-event-fire">fire an event</dfn>.
      </p>
      <p>
        The following is used but not defined in [[FULLSCREEN]]: <dfn><a href=
        'https://github.com/whatwg/fullscreen/issues/16'>animation frame
        task</a></dfn>.
      </p>
      <div class='issue'>
        This should now be updated since the <a>animation frame task</a> issue
        is recently resolved and the timing is now defined.
      </div>
    </section>
    <section id='conformance'>
      <p>
        This specification defines conformance criteria that apply to a single
        product: the <dfn>user agent</dfn> that implements the interfaces that
        it contains.
      </p>
    </section>
    <section class='appendix'>
      <h2>
        Acknowledgments
      </h2>
      <p>
        Thanks to Marcos Cáceres, Christophe Dumez, Anne van Kesteren, Chundong
        Wang, Fuqiao Xue, and Chaals McCathie Nevile for their useful comments.
      </p>
      <p>
        Special thanks to Chris Jones and Jonas Sicking for their contributions
        to the initial design of this API.
      </p>
    </section>
  </body>
</html>
